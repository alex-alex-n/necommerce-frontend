name: SAST - Security Analysis

on:
  push:
    branches: [ main, master, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  schedule:
    # Ð•Ð¶ÐµÐ½ÐµÐ´ÐµÐ»ÑŒÐ½Ñ‹Ð¹ Ð·Ð°Ð¿ÑƒÑÐº Ð¿Ð¾ Ð²Ð¾ÑÐºÑ€ÐµÑÐµÐ½ÑŒÑÐ¼ Ð² 3:00
    - cron: '0 3 * * 0'
  workflow_dispatch:  # Ð ÑƒÑ‡Ð½Ð¾Ð¹ Ð·Ð°Ð¿ÑƒÑÐº

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  NODE_VERSION: '16'

jobs:
  dependency-scan:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Install dependencies
        run: npm install --legacy-peer-deps --no-audit
      
      - name: Run npm audit
        run: |
          echo "Running npm audit..."
          npm audit --audit-level=moderate || true
      
      - name: Run Snyk Security Scan
        uses: snyk/actions/node@master
        if: false  # ÐžÑ‚ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¾ Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ, Ð½ÑƒÐ¶ÐµÐ½ API Ñ‚Ð¾ÐºÐµÐ½
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high
      
      - name: Run OWASP Dependency Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: 'necommerce-frontend'
          path: '.'
          format: 'HTML'
          args: >
            --scan .
            --out reports/
            --format HTML
            --format JSON
            --enableExperimental
            --failOnCVSS 7
      
      - name: Upload Dependency Check Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dependency-check-report
          path: reports/
          retention-days: 30

  code-scan:
    name: Source Code Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run Semgrep SAST
        uses: returntocorp/semgrep-action@v1
        with:
          config: p/security-audit
          outputFormat: sarif
          outputFile: semgrep-results.sarif
      
      - name: Upload Semgrep results to Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: semgrep-results.sarif
      
      - name: Run ESLint Security Rules
        run: |
          if [ -f package.json ]; then
            npx eslint . --config .eslintrc.json --ext .js,.jsx,.ts,.tsx \
              --rule 'security/detect-object-injection: error' \
              --rule 'security/detect-buffer-noassert: error' \
              --rule 'security/detect-child-process: error' \
              --rule 'security/detect-disable-mustache-escape: error' \
              --rule 'security/detect-eval-with-expression: error' \
              --rule 'security/detect-non-literal-fs-filename: error' \
              --rule 'security/detect-non-literal-regexp: error' \
              --rule 'security/detect-non-literal-require: error' \
              --rule 'security/detect-possible-timing-attacks: error' \
              --rule 'security/detect-pseudoRandomBytes: error' \
              --rule 'security/detect-bidi-characters: error' \
              --no-eslintrc \
              -f json -o eslint-security-report.json 2>/dev/null || echo "ESLint security check completed"
          else
            echo "No package.json found, skipping ESLint security scan"
          fi
      
      - name: Upload ESLint Security Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: eslint-security-report
          path: eslint-security-report.json
          retention-days: 30

  container-scan:
    name: Container Image Security Scan
    runs-on: ubuntu-latest
    needs: [dependency-scan, code-scan]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Build Docker image for scanning
        run: |
          docker build -t ${{ env.IMAGE_NAME }}:${{ github.sha }} .
      
      - name: Run Trivy Vulnerability Scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ env.IMAGE_NAME }}:${{ github.sha }}'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'HIGH,CRITICAL'
          exit-code: '0'  # ÐÐµ Ñ„ÐµÐ¹Ð»Ð¸Ñ‚ÑŒ ÑÐ±Ð¾Ñ€ÐºÑƒ, Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ñ€ÐµÐ¿Ð¾Ñ€Ñ‚
      
      - name: Upload Trivy results to Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: trivy-results.sarif
      
      - name: Run Grype Vulnerability Scanner
        uses: anchore/scan-action@v3
        with:
          image: ${{ env.IMAGE_NAME }}:${{ github.sha }}
          fail-build: false
          severity-cutoff: high
      
      - name: Run Dockle Image Linter
        run: |
          docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
            goodwithtech/dockle:v0.4.11 \
            ${{ env.IMAGE_NAME }}:${{ github.sha }} \
            --exit-code 0 \
            --format json \
            --output dockle-report.json || true
      
      - name: Upload Dockle Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dockle-report
          path: dockle-report.json
          retention-days: 30

  secrets-scan:
    name: Secrets Detection
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ÐŸÐ¾Ð»Ð½Ð°Ñ Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ñ Ð´Ð»Ñ Ð¿Ð¾Ð¸ÑÐºÐ° ÑÐµÐºÑ€ÐµÑ‚Ð¾Ð²
      
      - name: Run Gitleaks for secrets detection
        uses: gitleaks/gitleaks-action@v2
        env:
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}
        with:
          config-path: .gitleaks.toml
          redact: true
          verbose: true
      
      - name: Run TruffleHog for secrets scanning
        run: |
          docker run --rm -v "$(pwd):/workdir" trufflesecurity/trufflehog:latest \
            filesystem /workdir \
            --json \
            --only-verified \
            --no-update \
            --fail=0 \
            > trufflehog-report.json || true
      
      - name: Upload TruffleHog Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trufflehog-report
          path: trufflehog-report.json
          retention-days: 30

  security-summary:
    name: Security Analysis Summary
    runs-on: ubuntu-latest
    needs: [dependency-scan, code-scan, container-scan, secrets-scan]
    if: always()
    
    steps:
      - name: Generate Security Summary
        run: |
          echo "# ðŸ›¡ï¸ Security Analysis Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“Š Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Repository**: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## âœ… Completed Security Scans" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Dependency Vulnerability Scan" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Source Code Security Analysis" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Container Image Security Scan" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Secrets Detection" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“ Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Detailed reports are available in the Artifacts section:" >> $GITHUB_STEP_SUMMARY
          echo "- Dependency Check Reports" >> $GITHUB_STEP_SUMMARY
          echo "- ESLint Security Report" >> $GITHUB_STEP_SUMMARY
          echo "- Container Scan Reports" >> $GITHUB_STEP_SUMMARY
          echo "- Secrets Detection Reports" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ”’ Security Recommendations" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Review all security findings in the reports" >> $GITHUB_STEP_SUMMARY
          echo "2. Update dependencies with known vulnerabilities" >> $GITHUB_STEP_SUMMARY
          echo "3. Address high and critical severity issues first" >> $GITHUB_STEP_SUMMARY
          echo "4. Regularly run SAST scans on schedule" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Report generated on $(date)*" >> $GITHUB_STEP_SUMMARY
      
      - name: Send Security Alert (Optional)
        if: failure()
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_CHANNEL: security-alerts
          SLACK_TITLE: "Security Scan Failed"
          SLACK_MESSAGE: "Security scan detected issues in ${{ github.repository }}"
          SLACK_COLOR: danger
