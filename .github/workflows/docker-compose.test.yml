# .github/workflows/security.yml
name: Security Scan

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  zap-scan:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Setup Docker Compose
      run: |
        # Убедитесь, что docker-compose.yml есть в корне
        if [ ! -f "docker-compose.yml" ]; then
          echo "Creating docker-compose.yml..."
          echo 'version: "3.7"
services:
  backend:
    image: ghcr.io/netology-code/necommerce-backend
    ports:
      - "9999:9999"
  frontend:
    image: ghcr.io/netology-code/necommerce-frontend
    environment:
      - API=http://backend:9999
      - MEDIA=http://backend:9999
    ports:
      - "8888:80"
    depends_on:
      - backend' > docker-compose.yml
        fi
    
    - name: Start app
      run: |
        docker-compose up -d
        sleep 15
        curl -f http://localhost:8888 || echo "Frontend started"
        curl -f http://localhost:9999 || echo "Backend started"
    
    - name: Quick ZAP scan
      run: |
        docker run -i owasp/zap2docker-stable zap-baseline.py \
          -t http://host.docker.internal:8888 \
          -r report.html \
          -I
    
    - name: Save report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: zap-report
        path: report.html
    
    - name: Stop app
      if: always()
      run: docker-compose down
