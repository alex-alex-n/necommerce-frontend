name: Security Analysis Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 9 * * 1'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  BACKEND_IMAGE_NAME: netology-code/necommerce-backend
  FRONTEND_IMAGE_NAME: netology-code/necommerce-frontend
  DOCKER_COMPOSE_VERSION: v2.23.0

jobs:
  sast:
    runs-on: ubuntu-latest
    name: SAST Analysis
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Semgrep SAST
        uses: returntocorp/semgrep-action@v1
        with:
          config: auto
          output: semgrep-results.json
        continue-on-error: true

      - name: Upload SAST report
        uses: actions/upload-artifact@v4
        with:
          name: sast-report
          path: semgrep-results.json
          retention-days: 30

  dependency-scanning:
    runs-on: ubuntu-latest
    name: Dependency Scanning
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Trivy
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin v0.48.2

      - name: Scan Python dependencies
        run: |
          if [ -f "requirements.txt" ] || [ -f "Pipfile" ] || [ -f "pyproject.toml" ]; then
            trivy fs --format json --output trivy-python-deps.json --scanners vuln .
          else
            echo "No Python dependency files found"
          fi

      - name: Scan Node.js dependencies
        run: |
          if [ -f "package.json" ]; then
            trivy fs --format json --output trivy-node-deps.json --scanners vuln .
          elif [ -d "frontend" ] && [ -f "frontend/package.json" ]; then
            trivy fs --format json --output trivy-node-deps.json --scanners vuln frontend/
          else
            echo "No Node.js dependency files found"
          fi

      - name: Upload dependency reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dependency-reports
          path: |
            trivy-*.json
          retention-days: 30

  container-scanning:
    runs-on: ubuntu-latest
    name: Container Scanning
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker
        uses: docker/setup-buildx-action@v3

      - name: Install Trivy
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin v0.48.2

      - name: Scan backend image
        run: |
          trivy image --format json --output trivy-backend.json \
            --scanners vuln,secret,config \
            ghcr.io/netology-code/necommerce-backend:latest

      - name: Scan frontend image
        run: |
          trivy image --format json --output trivy-frontend.json \
            --scanners vuln,secret,config \
            ghcr.io/netology-code/necommerce-frontend:latest

      - name: Upload container scan reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: container-reports
          path: |
            trivy-backend.json
            trivy-frontend.json
          retention-days: 30

  secret-scanning:
    runs-on: ubuntu-latest
    name: Secret Scanning
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          config-path: .gitleaks.toml
          redact: true
          verbose: true
        continue-on-error: true

  deploy-and-dast:
    runs-on: ubuntu-latest
    name: Deploy and DAST Scan
    needs: [dependency-scanning, container-scanning]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Docker Compose
        run: |
          # Устанавливаем Docker Compose
          sudo curl -L "https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-$(uname -s)-$(uname -m)" \
            -o /usr/local/bin/docker-compose
          sudo chmod +x /usr/local/bin/docker-compose
          docker-compose --version

      - name: Start application with Docker Compose
        run: |
          # Запускаем приложение
          docker-compose up -d
          
          # Ждем запуска сервисов
          echo "Waiting for services to start..."
          sleep 45
          
          # Проверяем статус
          docker-compose ps
          
          # Проверяем доступность
          echo "Testing frontend..."
          curl -f http://localhost:8888 -o /dev/null -w "HTTP Code: %{http_code}\n" || echo "Frontend may still be starting"
          
          echo "Testing backend..."
          curl -f http://localhost:9999 -o /dev/null -w "HTTP Code: %{http_code}\n" || echo "Backend may still be starting"

      - name: Install OWASP ZAP
        run: |
          # Скачиваем и распаковываем ZAP
          ZAP_VERSION="2.14.0"
          wget "https://github.com/zaproxy/zaproxy/releases/download/v${ZAP_VERSION}/ZAP_${ZAP_VERSION}_Linux.tar.gz"
          tar -xzf "ZAP_${ZAP_VERSION}_Linux.tar.gz"
          sudo mv "ZAP_${ZAP_VERSION}" /opt/zap
          sudo chmod +x /opt/zap/zap.sh

      - name: Run OWASP ZAP baseline scan
        run: |
          # Запускаем ZAP в фоновом режиме
          /opt/zap/zap.sh -daemon -host 0.0.0.0 -port 8090 -config api.disablekey=true &
          ZAP_PID=$!
          
          # Ждем запуска ZAP
          sleep 20
          
          # Запускаем сканирование
          /opt/zap/zap.sh -cmd -quickurl http://localhost:8888 \
            -quickprogress -quickout /tmp/zap-report.html \
            -config api.disablekey=true
          
          # Останавливаем ZAP
          kill $ZAP_PID
          sleep 5

      - name: Run OWASP ZAP full scan
        run: |
          # Альтернативный вариант с Docker
          docker run --name zap \
            -v $(pwd):/zap/wrk/:rw \
            -p 8090:8090 \
            -d \
            owasp/zap2docker-stable zap.sh \
            -daemon -host 0.0.0.0 -port 8090 \
            -config api.disablekey=true
          
          sleep 20
          
          # Сканирование
          docker exec zap zap-cli --api-key '' quick-scan \
            --start-options="-config api.disablekey=true" \
            --self-contained --spider -r http://host.docker.internal:8888
          
          # Генерация отчетов
          docker exec zap zap-cli --api-key '' report \
            -o /zap/wrk/zap-report.html -f html
          
          docker exec zap zap-cli --api-key '' report \
            -o /zap/wrk/zap-report.json -f json
          
          docker stop zap
          docker rm zap

      - name: Upload ZAP reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dast-reports
          path: |
            zap-report.html
            zap-report.json
            /tmp/zap-report.html
          retention-days: 30

      - name: Stop Docker Compose
        if: always()
        run: |
          docker-compose down || true
          docker system prune -f || true

  security-dashboard:
    runs-on: ubuntu-latest
    name: Security Dashboard
    needs: [sast, dependency-scanning, container-scanning, secret-scanning, deploy-and-dast]
    if: always()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Generate consolidated report
        run: |
          echo "# Security Analysis Report" > SECURITY_REPORT.md
          echo "Generated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> SECURITY_REPORT.md
          echo "Commit: ${{ github.sha }}" >> SECURITY_REPORT.md
          echo "Branch: ${{ github.ref_name }}" >> SECURITY_REPORT.md
          echo "" >> SECURITY_REPORT.md
          
          echo "## Summary" >> SECURITY_REPORT.md
          echo "" >> SECURITY_REPORT.md
          echo "| Check Type | Status | Notes |" >> SECURITY_REPORT.md
          echo "|------------|--------|-------|" >> SECURITY_REPORT.md
          echo "| SAST | ${{ needs.sast.result }} | Static Application Security Testing |" >> SECURITY_REPORT.md
          echo "| Dependency Scanning | ${{ needs.dependency-scanning.result }} | Open Source Analysis |" >> SECURITY_REPORT.md
          echo "| Container Scanning | ${{ needs.container-scanning.result }} | Docker Image Analysis |" >> SECURITY_REPORT.md
          echo "| Secret Scanning | ${{ needs.secret-scanning.result }} | Secrets Detection |" >> SECURITY_REPORT.md
          echo "| DAST | ${{ needs.deploy-and-dast.result }} | Dynamic Application Security Testing |" >> SECURITY_REPORT.md
          echo "" >> SECURITY_REPORT.md
          
          echo "## Details" >> SECURITY_REPORT.md
          echo "" >> SECURITY_REPORT.md
          echo "### Next Steps:" >> SECURITY_REPORT.md
          echo "1. Review all security reports in the artifacts" >> SECURITY_REPORT.md
          echo "2. Address critical and high severity findings first" >> SECURITY_REPORT.md
          echo "3. Update dependencies regularly" >> SECURITY_REPORT.md
          echo "4. Implement security fixes in the next sprint" >> SECURITY_REPORT.md

      - name: Upload final report
        uses: actions/upload-artifact@v4
        with:
          name: final-security-report
          path: |
            SECURITY_REPORT.md
            artifacts/
          retention-days: 90

      - name: Create Security Summary
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const summary = `
            ## Security Scan Results
            
            Security analysis has been completed for this PR. Here are the results:
            
            - ✅ SAST: ${{ needs.sast.result }}
            - ✅ Dependency Scanning: ${{ needs.dependency-scanning.result }}
            - ✅ Container Scanning: ${{ needs.container-scanning.result }}
            - ✅ Secret Scanning: ${{ needs.secret-scanning.result }}
            - ✅ DAST: ${{ needs.deploy-and-dast.result }}
            
            Detailed reports are available in the workflow artifacts.
            
            **Note:** Please review any security findings before merging.
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });
