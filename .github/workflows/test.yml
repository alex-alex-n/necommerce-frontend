name: Security Analysis Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 9 * * 1'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  BACKEND_IMAGE_NAME: netology-code/necommerce-backend
  FRONTEND_IMAGE_NAME: netology-code/necommerce-frontend

jobs:
  sast:
    runs-on: ubuntu-latest
    name: SAST Analysis
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Semgrep
        run: |
          docker run --rm -v "$(pwd):/src" returntocorp/semgrep semgrep scan --config auto --json --output semgrep-report.json /src
        continue-on-error: true

      - name: Upload SAST report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: sast-report
          path: semgrep-report.json
          retention-days: 30

  dependency-scanning:
    runs-on: ubuntu-latest
    name: Dependency Scanning
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Run Trivy for dependencies
        run: |
          docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
            -v "$(pwd):/src" aquasec/trivy:latest \
            fs --format json --output /src/trivy-deps.json --scanners vuln /src
        continue-on-error: true

      - name: Upload dependency reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dependency-reports
          path: trivy-deps.json
          retention-days: 30

  container-scanning:
    runs-on: ubuntu-latest
    name: Container Scanning
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy for containers
        run: |
          # Ð¡ÐºÐ°Ð½Ð¸Ñ€ÑƒÐµÐ¼ backend Ð¾Ð±Ñ€Ð°Ð·
          docker run --rm aquasec/trivy:latest \
            image --format json --output trivy-backend.json \
            --scanners vuln,secret,config \
            ghcr.io/netology-code/necommerce-backend:latest
          
          # Ð¡ÐºÐ°Ð½Ð¸Ñ€ÑƒÐµÐ¼ frontend Ð¾Ð±Ñ€Ð°Ð·
          docker run --rm aquasec/trivy:latest \
            image --format json --output trivy-frontend.json \
            --scanners vuln,secret,config \
            ghcr.io/netology-code/necommerce-frontend:latest
        continue-on-error: true

      - name: Upload container scan reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: container-reports
          path: |
            trivy-backend.json
            trivy-frontend.json
          retention-days: 30

  secret-scanning:
    runs-on: ubuntu-latest
    name: Secret Scanning
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        run: |
          docker run --rm -v "$(pwd):/src" zricethezav/gitleaks:latest \
            detect --source /src --report-format json --report-path /src/gitleaks-report.json --verbose
        continue-on-error: true

      - name: Upload secret scan report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: secret-report
          path: gitleaks-report.json
          retention-days: 30

  deploy-and-dast:
    runs-on: ubuntu-latest
    name: Deploy and DAST Scan
    needs: [dependency-scanning, container-scanning]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Docker Compose
        run: |
          # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Docker Compose Ñ‡ÐµÑ€ÐµÐ· pip (Ð½Ð°Ð´ÐµÐ¶Ð½Ñ‹Ð¹ ÑÐ¿Ð¾ÑÐ¾Ð±)
          python -m pip install --upgrade pip
          pip install docker-compose

      - name: Verify Docker Compose Installation
        run: |
          docker-compose --version
          which docker-compose

      - name: Start application
        run: |
          echo "Starting application with Docker Compose..."
          docker-compose up -d
          
          echo "Waiting for services to start (60 seconds)..."
          sleep 60
          
          echo "Checking service status..."
          docker-compose ps
          
          echo "Testing frontend connectivity..."
          curl -f http://localhost:8888 -o /dev/null -w "Frontend HTTP Code: %{http_code}\n" -m 30 || echo "Frontend check failed"
          
          echo "Testing backend connectivity..."
          curl -f http://localhost:9999 -o /dev/null -w "Backend HTTP Code: %{http_code}\n" -m 30 || echo "Backend check failed"
          
          echo "Listing running containers..."
          docker ps

      - name: Run OWASP ZAP Scan
        run: |
          echo "Starting OWASP ZAP scan..."
          
          # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ZAP Ñ‡ÐµÑ€ÐµÐ· Docker
          docker run --name zap -d \
            -u zap \
            -p 8080:8080 \
            -i \
            owasp/zap2docker-stable zap.sh \
            -daemon -host 0.0.0.0 -port 8080 \
            -config api.disablekey=true \
            -config api.addrs.addr.name=.* \
            -config api.addrs.addr.regex=true
          
          echo "Waiting for ZAP to start..."
          sleep 20
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ ZAP Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½
          curl -s http://localhost:8080 || echo "ZAP API check"
          
          echo "Running ZAP spider scan..."
          docker exec zap zap-cli --api-key '' open-url http://host.docker.internal:8888
          docker exec zap zap-cli --api-key '' spider http://host.docker.internal:8888
          sleep 10
          
          echo "Running ZAP active scan..."
          docker exec zap zap-cli --api-key '' active-scan http://host.docker.internal:8888
          sleep 30
          
          echo "Generating ZAP reports..."
          docker exec zap zap-cli --api-key '' report -o /zap/wrk/zap-report.html -f html
          docker exec zap zap-cli --api-key '' report -o /zap/wrk/zap-report.json -f json
          
          # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ð¾Ñ‚Ñ‡ÐµÑ‚Ñ‹ Ð¸Ð· ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð°
          docker cp zap:/zap/wrk/zap-report.html .
          docker cp zap:/zap/wrk/zap-report.json .
          
          # ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ZAP
          docker stop zap
          docker rm zap
        continue-on-error: true

      - name: Upload ZAP reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dast-reports
          path: |
            zap-report.html
            zap-report.json
          retention-days: 30

      - name: Cleanup
        if: always()
        run: |
          echo "Cleaning up Docker resources..."
          docker-compose down -v || true
          docker system prune -af || true
          docker volume prune -f || true

  security-report:
    runs-on: ubuntu-latest
    name: Generate Security Report
    needs: [sast, dependency-scanning, container-scanning, secret-scanning, deploy-and-dast]
    if: always()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Generate summary report
        run: |
          cat > SECURITY_SUMMARY.md << 'EOF'
          # Security Analysis Summary
          
          ## Overview
          Security analysis completed for commit: ${{ github.sha }}
          
          ## Results Summary
          
          EOF
          
          # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑÑ‹
          echo "| Tool | Status |" >> SECURITY_SUMMARY.md
          echo "|------|--------|" >> SECURITY_SUMMARY.md
          echo "| SAST (Semgrep) | ${{ needs.sast.result }} |" >> SECURITY_SUMMARY.md
          echo "| Dependency Scanning (Trivy) | ${{ needs.dependency-scanning.result }} |" >> SECURITY_SUMMARY.md
          echo "| Container Scanning (Trivy) | ${{ needs.container-scanning.result }} |" >> SECURITY_SUMMARY.md
          echo "| Secret Scanning (Gitleaks) | ${{ needs.secret-scanning.result }} |" >> SECURITY_SUMMARY.md
          echo "| DAST (OWASP ZAP) | ${{ needs.deploy-and-dast.result }} |" >> SECURITY_SUMMARY.md
          
          cat >> SECURITY_SUMMARY.md << 'EOF'
          
          ## Artifacts
          All detailed reports are available as workflow artifacts.
          
          ## Recommendations
          1. Review all security findings in the attached reports
          2. Prioritize critical and high severity vulnerabilities
          3. Update dependencies regularly
          4. Implement security fixes in upcoming sprints
          
          EOF

      - name: Upload final report
        uses: actions/upload-artifact@v4
        with:
          name: final-security-report
          path: |
            SECURITY_SUMMARY.md
            artifacts/
          retention-days: 90

      - name: Create PR Comment
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let summary = `## ðŸ”’ Security Scan Results for PR #${context.issue.number}

            ### Scan Status:
            âœ… **SAST Analysis:** ${context.job === 'security-report' ? context.job.result : 'pending'}
            âœ… **Dependency Scanning:** ${context.job === 'security-report' ? context.job.result : 'pending'}
            âœ… **Container Scanning:** ${context.job === 'security-report' ? context.job.result : 'pending'}
            âœ… **Secret Detection:** ${context.job === 'security-report' ? context.job.result : 'pending'}
            âœ… **DAST Analysis:** ${context.job === 'security-report' ? context.job.result : 'pending'}

            ðŸ“Š **Detailed reports are available in the workflow artifacts.**

            **Next Steps:**
            1. Review security findings
            2. Address critical vulnerabilities before merging
            3. Check artifact files for detailed information
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });
