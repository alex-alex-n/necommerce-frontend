name: Security CI Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  # 1. Подготовка окружения и запуск docker-compose
  setup-and-compose:
    runs-on: ubuntu-latest
    services:
      docker:
        image: docker:24.0.2-dind
        privileged: true
        options: >-
          --dns 8.8.8.8
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Start services via docker-compose
        run: |
          docker-compose up -d
          docker ps

      - name: Wait for services to be ready
        run: |
          for i in {1..30}; do
            if curl -sSf http://localhost:8888 > /dev/null; then
              echo "Frontend is up"
              break
            fi
            echo "Waiting for frontend..."
            sleep 5
          done

  # 2. SAST-анализ (пример: SonarCloud или CodeQL)
  sast:
    runs-on: ubuntu-latest
    needs: setup-and-compose
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Вариант 1. CodeQL (если требуется именно GitHub-native решение)
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript # или другие: javascript, java, python, etc.

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:javascript"

      # Пример выгрузки логов/отчётов
      - name: Upload CodeQL SARIF
        uses: actions/upload-artifact@v4
        with:
          name: sast-codeql-results
          path: ./results # путь скорректируйте под фактический

  # 3. OSA-анализ (анализ зависимостей)
  osa:
    runs-on: ubuntu-latest
    needs: setup-and-compose
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Пример: OWASP Dependency-Check (универсальный инструмент для Java, JS и др.)
      - name: Install Dependency-Check
        run: |
          wget https://github.com/jeremylong/DependencyCheck/releases/download/v10.0.2/dependency-check-10.0.2-release.zip
          unzip dependency-check-10.0.2-release.zip -d dependency-check
          chmod +x dependency-check/bin/dependency-check.sh

      - name: Run Dependency-Check
        run: |
          mkdir -p reports
          dependency-check/bin/dependency-check.sh \
            --scan . \
            --format "HTML" \
            --out reports \
            --project "necommerce"

      - name: Upload OSA report
        uses: actions/upload-artifact@v4
        with:
          name: osa-dependency-check-report
          path: reports

  # 4. Анализ образов и конфигурации контейнеров (Trivy)
  container-analysis:
    runs-on: ubuntu-latest
    needs: setup-and-compose
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Trivy
        uses: aquasecurity/trivy-action@0.24.0
        with:
          version: latest

      # Анализ образов
      - name: Scan backend image
        uses: aquasecurity/trivy-action@0.24.0
        with:
          image-ref: ghcr.io/netology-code/necommerce-backend
          format: 'table'
          output: 'trivy-backend.txt'
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH,MEDIUM,LOW'

      - name: Scan frontend image
        uses: aquasecurity/trivy-action@0.24.0
        with:
          image-ref: ghcr.io/netology-code/necommerce-frontend
          format: 'table'
          output: 'trivy-frontend.txt'
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH,MEDIUM,LOW'

      # Анализ конфигурации (docker-compose, Dockerfile, k8s yaml и др.)
      - name: Trivy config scan
        uses: aquasecurity/trivy-action@0.24.0
        with:
          scan-type: 'config'
          scan-ref: '.'
          format: 'table'
          output: 'trivy-config.txt'

      - name: Upload Trivy reports
        uses: actions/upload-artifact@v4
        with:
          name: trivy-reports
          path: |
            trivy-backend.txt
            trivy-frontend.txt
            trivy-config.txt

  # 5. Поиск секретов
  secrets-scan:
    runs-on: ubuntu-latest
    needs: setup-and-compose
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Вариант 1: Gitleaks
      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        with:
          args: detect -v --redact --report-format json --report-path gitleaks-report.json

      - name: Upload Gitleaks report
        uses: actions/upload-artifact@v4
        with:
          name: gitleaks-report
          path: gitleaks-report.json

  # 6. Динамический анализ (OWASP ZAP)
  dast-zap:
    runs-on: ubuntu-latest
    needs: setup-and-compose
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Start services via docker-compose
        run: |
          docker-compose up -d
          docker ps

      - name: Wait for frontend
        run: |
          for i in {1..30}; do
            if curl -sSf http://localhost:8888 > /dev/null; then
              echo "Frontend is up"
              break
            fi
            echo "Waiting for frontend..."
            sleep 5
          done

      # Запуск ZAP в режиме baseline/quick scan
      - name: Run OWASP ZAP Baseline Scan
        run: |
          docker run --network host -v $PWD:/zap/wrk/:rw -t owasp/zap2docker-stable zap-baseline.py \
            -t http://localhost:8888 \
            -r zap-report.html \
            -x zap-report.xml \
            -I

      - name: Upload ZAP reports
        uses: actions/upload-artifact@v4
        with:
          name: zap-reports
          path: |
            zap-report.html
            zap-report.xml
