name: Security CI Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  # 1. Подготовка окружения и запуск docker compose
  setup-and-compose:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Start services via docker compose
        run: |
          docker compose up -d
          docker ps

      - name: Wait for services to be ready
        run: |
          echo "=== Waiting for frontend on http://localhost:8888 ==="
          for i in {1..30}; do
            status=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8888 || echo "000")
            echo "Attempt $i: frontend HTTP status: $status"
            if [ "$status" = "200" ]; then
              echo "Frontend is up"
              break
            fi
            sleep 5
          done

          echo "=== Waiting for backend on http://localhost:9999 ==="
          for i in {1..30}; do
            status=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:9999 || echo "000")
            echo "Attempt $i: backend HTTP status: $status"
            if [ "$status" != "000" ]; then
              echo "Backend is up (HTTP $status)"
              break
            fi
            sleep 5
          done

  # 2. Анализ образов и конфигурации контейнеров (Trivy)
  container-analysis:
    runs-on: ubuntu-latest
    needs: setup-and-compose
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Scan backend image
        uses: aquasecurity/trivy-action@0.24.0
        with:
          scan-type: image
          image-ref: ghcr.io/netology-code/necommerce-backend
          format: 'table'
          output: 'trivy-backend.txt'
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH,MEDIUM,LOW'

      - name: Scan frontend image
        uses: aquasecurity/trivy-action@0.24.0
        with:
          scan-type: image
          image-ref: ghcr.io/netology-code/necommerce-frontend
          format: 'table'
          output: 'trivy-frontend.txt'
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH,MEDIUM,LOW'

      - name: Trivy config scan
        uses: aquasecurity/trivy-action@0.24.0
        with:
          scan-type: 'config'
          scan-ref: '.'
          format: 'table'
          output: 'trivy-config.txt'

      - name: Upload Trivy reports
        uses: actions/upload-artifact@v4
        with:
          name: trivy-reports
          path: |
            trivy-backend.txt
            trivy-frontend.txt
            trivy-config.txt

  # 3. Динамический анализ (OWASP ZAP)
  dast-zap:
    runs-on: ubuntu-latest
    needs: setup-and-compose
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Start services via docker compose
        run: |
          docker compose up -d
          docker ps

      - name: Wait for frontend
        run: |
          echo "=== Waiting for frontend on http://localhost:8888 ==="
          for i in {1..30}; do
            status=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8888 || echo "000")
            echo "Attempt $i: frontend HTTP status: $status"
            if [ "$status" = "200" ]; then
              echo "Frontend is up"
              break
            fi
            sleep 5
          done

      - name: Run OWASP ZAP Baseline Scan
        run: |
          # Дадим права на запись в рабочей директории (на всякий случай)
          chmod -R 777 "$PWD"
          docker run --rm --network host \
            -u 0:0 \
            -v "$PWD:/zap/wrk/:rw" \
            ghcr.io/zaproxy/zaproxy:stable \
            zap-baseline.py \
            -t http://localhost:8888 \
            -r zap-report.html \
            -x zap-report.xml \
            -I

      - name: Upload ZAP reports
        uses: actions/upload-artifact@v4
        with:
          name: zap-reports
          path: |
            zap-report.html
            zap-report.xml
